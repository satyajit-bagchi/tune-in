<html>
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="icon" type="image/png" sizes="174x174" href="./style/favicon.png">
	<script src="https://tonejs.github.io/build/Tone.js"></script>
	<script src="./scripts/jquery.min.js"></script>
	<script src="./scripts/draggabilly.js"></script>
	<script src="./scripts/StartAudioContext.js"></script>
	<script src="./scripts/Interface.js"></script>
	<script src="https://tonejs.github.io/Logo/build/Logo.js"></script>
	<script src="./scripts/Keyboard.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
  <script>
  var notesplayed = [];

  var notes = [
    "440", "466.164", "493.883", "523.251", "554.365", "587.330", "622.254", "659.255", "698.456", "739.989", "783.991", "830.609","880.000"
  ];

  function writeMelodyJson(noteplayed){
        // Create an entry
        var postData = {
          "notes":[{
              "duration": 0.39,
              "name": noteplayed,
              "time": 0
            }
          ]// Get a key for a new Post.
        }
        firebase.database().ref().child('midiwrite').update(postData);
      }
var synth = new Tone.Synth().toMaster();

function pushSound(note) {
    duration = 0
    timer()
    durationTimer()
    synth.triggerAttack(notes[note]);
    writeMelodyJson(notes[note]);
}


function stopSound() {
    clearTimeout(d);
    synth.triggerRelease();
}

</script>

    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyD0cf2mNyPChLU8FAVUhgw2rwVsLjKYty8",
            authDomain: "tune-in-b3959.firebaseapp.com",
            databaseURL: "https://tune-in-b3959.firebaseio.com",
            projectId: "tune-in-b3959",
            storageBucket: "tune-in-b3959.appspot.com",
            messagingSenderId: "219762201728"
        };
        firebase.initializeApp(config);

        var dbRef = firebase.database().ref().child('midislim')
        dbRef.on('value', snapshot => {
            console.log('retrieving')
            console.log(snapshot.val())
            play(snapshot.val())
        });

        function play(midi) {
            var synth = new Tone.PolySynth(8).toMaster();

            // pass in the note events from one of the tracks as the second argument to Tone.Part
            var midiPart = new Tone.Part(function (time, note) {

                //use the events to play the synth
                synth.triggerAttackRelease(note.name, note.duration, time, note.velocity)

            }, midi.notes).start();

            // start the transport to hear the events
            Tone.Transport.start();
        }
    </script>

    <div id='container1'>
      <div id='container2'>
        <div class='white_key key' onmousedown='pushSound(0)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(0)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(1)' onmouseup='stopSound()'></div>
        <div class='black_key key' onmousedown='pushSound(1)' onmouseup='stopSound()'></div>
        <div class='white_key key' onmousedown='pushSound(2)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(2)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(3)' onmouseup='stopSound()'></div>
        <div class='black_key key' onmousedown='pushSound(3)' onmouseup='stopSound()'></div>
        <div class='white_key key' onmousedown='pushSound(4)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(4)' onmouseup='stopSound()'></div>
        <div class='white_key key' onmousedown='pushSound(5)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(5)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(6)' onmouseup='stopSound()'></div>
        <div class='black_key key' onmousedown='pushSound(6)' onmouseup='stopSound()'></div>
        <div class='white_key key' onmousedown='pushSound(7)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(7)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(8)' onmouseup='stopSound()'></div>
        <div class='black_key key' onmousedown='pushSound(8)' onmouseup='stopSound()'></div>
        <div class='white_key key' onmousedown='pushSound(9)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(9)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(10)' onmouseup='stopSound()'></div>
        <div class='black_key key' onmousedown='pushSound(10)' onmouseup='stopSound()'></div>
        <div class='white_key key' onmousedown='pushSound(11)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(11)' onmouseup='stopSound()'></div>
        <div class='white_key key' onmousedown='pushSound(12)' onmouseup='stopSound()'></div>
        <div onmousedown='pushSound(12)' onmouseup='stopSound()'></div>
      </div>
    </div>

<h1 id="time"><time>0</time></h1>
<h1 id="duration"><time>0</time></h1>

</body>
<script>
  //Timer parts
  var timeDisplay = document.getElementById('time'),
      durationDisplay = document.getElementById('duration'),
      time = 0, duration = 0,
      t, d;

  function timer() {
      t = setTimeout(add, 1);
  }
  function durationTimer(){
    d = setTimeout(durationAdd, 1);
  }
  function add() {
      time++;
      timeDisplay.textContent = time;
      timer();
  }
  function durationAdd(){
    duration++;
    durationDisplay.textContent = duration;
    durationTimer();

  }

</script>
</html>
